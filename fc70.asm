; ============================================
; МОДУЛЬ: sub_FC70 - Полный обработчик Select и запуска игр
; Включает:
;   - Проверку нажатия Select
;   - Проверку дополнительного устройства
;   - Код запуска игры (loc_FF00)
;   - Дополнительную настройку (sub_FF4E)
; ============================================

.ifndef SUB_FC70_INC
SUB_FC70_INC = 1

.include "constants.inc"

.segment "CODE"

; ============================================
; PROC: sub_FC70
; Назначение: Основной обработчик Select в многоигровом меню
; Логика:
;   1. Если Select нажат → устанавливает MENU_SLOT=1 и запускает игру
;   2. Если Select не нажат → проверяет дополнительное устройство
; ============================================
.proc sub_FC70
    ; Обновляем состояние контроллеров
    jsr sub_D01E          ; → var_3BD, var_3BE
    
    ; Проверяем нажатие Select (бит 5 в стандартном NES)
    ; Но в нашем коде проверяется бит 6 ($40)
    lda var_3BD           ; Состояние контроллера 1
    and #$40              ; Маска 01000000 (бит 6)
    cmp #$40              ; Если бит 6 = 1
    bne @check_device     ; Если не нажат, проверяем устройство
    
    ; ========================================
    ; SELECT НАЖАТ - ЗАПУСК ИГРЫ
    ; ========================================
    lda #1
    sta var_3F0           ; MENU_SLOT = 1 (флаг выбора)
    jmp loc_FF00          ; Переходим к коду запуска игры

@check_device:
    ; ========================================
    ; ПРОВЕРКА ДОПОЛНИТЕЛЬНОГО УСТРОЙСТВА
    ; (Батарейка сохранения или другая периферия)
    ; ========================================
    lda #0
    sta REG_4118          ; Сброс регистров устройства
    sta REG_4116
    
    ; Настройка запроса
    lda #7                ; Команда 7: "проверить наличие"
    sta REG_412B          ; Регистр команд
    lda #0
    sta REG_412C          ; Очистка регистра данных
    
    ; Пауза для обработки (6 NOP ≈ 12 тактов)
    nop
    nop
    nop
    nop
    nop
    nop
    
    ; Чтение ответа
    lda REG_412C          ; Статус устройства
    and #8                ; Проверяем бит 3 (00001000)
    bne @device_ok        ; Если бит 3 = 1, устройство работает
    
    ; Устройство не отвечает
    lda #0
    sta DEVICE_STATUS     ; $58C = 0 (устройство отсутствует/не работает)
    rts

@device_ok:
    ; Устройство работает
    lda #1
    sta DEVICE_STATUS     ; $58C = 1 (устройство присутствует/работает)
    rts
.endproc

; ============================================
; PROC: loc_FF00 - Запуск выбранной игры
; Выполняется только при нажатии Select
; ============================================
loc_FF00:
    ; Копируем код запуска игры из ROM в RAM
    ldy #0
@copy_loop:
    lda LAUNCH_CODE_SRC, y  ; Читаем из $FF14+y
    sta LAUNCH_CODE_DST, y  ; Пишем в $0408+y
    iny
    cpy #LAUNCH_CODE_LEN    ; 59 байт
    bcc @copy_loop
    
    ; Дополнительная настройка банков VROM
    jsr sub_FF4E
    
    ; Запускаем скопированный код
    jmp LAUNCH_CODE_DST     ; jmp $0408
    ; Дальнейшее выполнение продолжается в скопированном коде

; ============================================
; PROC: sub_FF4E - Дополнительная настройка перед запуском
; Настраивает банки VROM для игры
; ============================================
.proc sub_FF4E
    lda #0
    sta VROM_BANK4          ; $2016 = 0
    lda #2
    sta VROM_BANK5          ; $2017 = 2
    
    lda #4
    sta VROM_BANK0          ; $2012 = 4
    lda #5
    sta VROM_BANK1          ; $2013 = 5
    lda #6
    sta VROM_BANK2          ; $2014 = 6
    lda #7
    sta VROM_BANK3          ; $2015 = 7
    
    rts
.endproc

; ============================================
; КОД ЗАПУСКА ИГРЫ (будет скопирован в $0408)
; Размещаем его здесь для наглядности
; ============================================
launch_code:
    .byte $A9, $00         ; lda #0
    .byte $8D, $00, $A0    ; sta $A000
    .byte $A9, $04         ; lda #4
    .byte $8D, $0B, $41    ; sta $410B
    .byte $A2, $FC         ; ldx #$FC
    .byte $8E, $07, $41    ; stx $4107
    .byte $E8              ; inx
    .byte $8E, $08, $41    ; stx $4108
    .byte $E8              ; inx
    .byte $8E, $09, $41    ; stx $4109
    .byte $E8              ; inx
    .byte $8E, $0A, $41    ; stx $410A
    .byte $A9, $33         ; lda #$33
    .byte $8D, $00, $41    ; sta $4100
    .byte $A9, $E4         ; lda #$E4
    .byte $8D, $1A, $20    ; sta $201A
    .byte $A9, $70         ; lda #$70
    .byte $8D, $18, $20    ; sta $2018
    .byte $AD, $39, $41    ; lda $4139
    .byte $09, $03         ; ora #3
    .byte $8D, $39, $41    ; sta $4139
    .byte $A9, $4B         ; lda #$4B
    .byte $8D, $38, $41    ; sta $4138
    .byte $6C, $FC, $FF    ; jmp ($FFFC)

.include "controllers.asm"    ; Подключаем чтение контроллеров

.endif ; SUB_FC70_INC